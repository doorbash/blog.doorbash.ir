---
layout: post
title: "پروژه جدید: بازی Solitaire Klondike"
img: solitaire.jpg
date: 2021-05-21
---

تو این پست میخام در مورد تجربه ای که از ساخت بازی ساده Solitaire Klondike داشتم صحبت کنم. و همینطور در مورد مسائلی که برای ساختش سعی کردم رعایت کنم نکاتی رو بگم که شاید به درد کسی که برنامه نویس بازی هست بخوره. و در آخر در مورد جزئیات فنی (زبان برنامه نویسی، موتور بازیسازی و کتابخونه های استفاده شده) توضیح میدم.

این بازی (Solitaire) یک بازی اندرویدی یک نفره با ورق (پاسور) هست که فعلا قابلیت های زیر رو داره:
- حالت سه کارتی و تک کارتی
- حرکت با لمس کارت
- نمایش امتیاز و زمان
- دکمه آندو (برگرداندن)
- چینش دست چپی
- امکان تعیین جهت صفحه (افقی، عمودی یا چرخش خودکار)
- دو نوع چینش حالت افقی
- نمایش آمار بازی و لیست بازی های قبلی 
- پشتیبانی از دو زبان فارسی و انگلیسی
- امکان قطع و وصل کردن صدای بازی

### بهره‌وری یا Performance

یکی از مسائلی که خیلی برای توسعه بازی مهم هست همین بحث بهره وریه. ساده بخوام بگم هدف اینه که از منابعی که در اختیار داریم (مثل حافظه RAM یا پردازنده یا گرافیک) کمتر استفاده کنیم. بازی ای که روان اجرا میشه مسلما تجربه بهتری به کاربر میده. هیچ کس دوست نداره بازی گیر کنه، هنگ کنه یا زیاد از باتری گوشیش استفاده کنه.

#### - فریم در ثانیه (FPS)

برای اینکه fps رو بیاریم پایین باید تعداد draw call هامون تو هر فریم رو کم کنیم. کاری که کردم این بود که تمام تصاویر، آیکون ها و فونت هایی که تو بازی استفاده شده رو در قالب یک عکس 1024x1024 پک کردم. اینطوری فقط یک تکسچر بایند میشه و تعداد draw call ها میشه 1.

#### - ذخیره و بازیابی از فایل
حالت (State) فعلی بازی بعد از هر حرکت باید توی فایل نوشته میشد . و زمانی که کاربر دوباره وارد بازی میشد از فایل خونده میشد. 

همینطور بازی های آسان قابل حل هم باید توی فایل ذخیره میشدن.

اول میخاستم از JSON استفاده کنم ولی ازونجایی که JSON به صورت متنی هست بهتر بود از روشی که باینری ذخیره میکنه استفاده میکردم. برای همین {{<inline_link "https://github.com/protocolbuffers/protobuf" "protobuf">}} رو انتخاب کردم. کتابخونه دیگه ای که از لحاظ بهره وری توی بنچمارک هایی که دیدم از protobuf بهتر بود {{<inline_link "https://github.com/EsotericSoftware/kryo" "kryo">}} بود که اونم میتونست انتخاب خوبی باشه.

این مثلا نحوه ذخیره لیست بازی ها رو نشون میده:
هر بازی 56 بایت فضا میگیره (52 کارت به اضافه کمی سربار که خود protobuf برای ذخیره ساختار اضافه میکنه)

```plaintext
message GamePB {
  bytes data = 1;
}

message GamesPB {
  repeated GamePB list = 1;
}
```

### حجم فایل نصبی
هرچه حجم فایل نصبی که کاربر قراره دانلود کنه کمتر باشه احتمال اینکه بازی ما نصب بیشتری بگیره بیشتره. این بازی ساده هست و چون حجم نهایی زیر 15MB هست میشه از قابلیت instant apps گوگل پلی استفاده کرد که حجم کمتر یک مزیت محسوب میشه.

 جدا از این برای ما که برای مارکت ایرانی هم جدا ریلیز میدیم این مساله مهمتر هم میشه. البته این چیزی که نیست که بخایم زیاد روش تمرکز کنیم ولی برای من (حداقل اولش) مهم بود که حجم بازی زیر یک مگابایت بشه (که آخرشم نشد!). 

با جدا کردن فایل .so هر معماری تو gradle و حذف فایل استایل libgdx و تعریف دستیشون تو کد و یه سری حذف های جزئی و proguard تونستم حجم فایل نهایی رو بیارم روی 750KB. 

اما بعد که protobuf اضافه کردم شد 920KB. هنوز زیر یک مگابایت بود! تا اینکه مجبور شدم برای رابط کابری از کتابخونه material گوگل استفاده کنم که با فونت ها و 20,000 بازی آسان حجم نهایی 3.6MB شد.

![not great not terrible](https://media.giphy.com/media/B2l0NnxK9KiVa0CXBh/giphy.gif)

### رابط کاربری
من همیشه سعی میکنم کاری کنم کاربر تو کمترین زمان و راحت ترین شکل ممکن به کاری که میخاد تو بازی بکنه برسه. مثلا اگه دکمه تنظیمات توی منوی بازی باشه کاربر باید اول بره توی منوی بازی و بعد از اونجا بره تنظیمات. این میشه دو مرحله. به این فکر میکنم که آیا میشه یک مرحله اش کنیم؟ بله یک دکمه تنظیمات میذاریم گوشه بالا سمت راست.

یا مثلا دکمه آندو برای حالت افقی میتونست بالا باشه ولی معمولا کاربری که داره با گوشی به صورت افقی کار میکنه داره یک دستی گوشی رو میگیره. پس بهتره بذاریمش پایین که به انگشت شصت نزدیک باشه.

### جزئیات فنی
بازی با استفاده از {{<inline_link "https://libgdx.com/" "LibGDX">}} ساخته شده و با زبان برنامه نویسی {{<inline_link "https://kotlinlang.org/" "کاتلین">}} (و کمی هم جاوا)

برای شروع ساخت پروژه از {{<inline_link "https://github.com/tommyettinger/gdx-liftoff" "gdx-liftoff">}}

برای گیم پلی و منو ها از {{<inline_link "https://github.com/libgdx/libgdx/wiki/Scene2d" "Scene2D">}} که برای LibGDX هست. 

از {{<inline_link "https://github.com/libktx/ktx" "LibKTX">}} برای کار کردن راحت تر با LibGDX

برای پک کردن عکس ها و فونت ها از {{<inline_link "https://github.com/raeleus/skin-composer" "Skin Composer">}}

برای ذخیره و بازیابی استیت بازی و همینطور بازیابی لیست بازی های آسان از {{<inline_link "https://github.com/protocolbuffers/protobuf" "protobuf">}}

 منوهای بازی (و دکمه ها و switch و spinner) هم ویجت کاستوم هستن که از  floatingGroup از کتابخونه {{<inline_link "https://github.com/kotcrab/vis-ui" "vis-ui">}} ارث بری میکنند. البته فقط دیالوگ منو، تنظیمات و خروج از بازی.
برای ساخت دیالوگ "بازی های قبلی" و "شما برنده شدید" از Dialog اندروید SDK استفاده شده. 

تم کل برنامه هم Theme.MaterialComponents.NoActionBar هست. 

از کتابخونه {{<inline_link "https://github.com/marlonlom/timeago" "timeago">}} برای نمایش تاریخ به صورت نسبی (مثلا دو ساعت پیش)

آیکون ها هم {{<inline_link "https://github.com/google/material-design-icons" "آیکون های متریال دیزاین">}} گوگل هستن
